// Claim Promo Code â€“ Assigns an unclaimed code to an email and sends via Postmark
// POST { email: string }
// Returns { ok: true, code: string } or { ok: false, error: string }

import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// Shared Supabase service client helper (inlined for Web UI deployment compatibility)
function serviceClient() {
    const url = Deno.env.get("SUPABASE_URL");
    const key = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY");
    if (!url || !key) {
        throw new Error("Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY in function secrets");
    }
    return createClient(url, key, { auth: { persistSession: false } });
}

const corsHeaders = {
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

serve(async (req: Request): Promise<Response> => {
    // Handle CORS preflight
    if (req.method === "OPTIONS") {
        return new Response("ok", { headers: corsHeaders });
    }

    if (req.method !== "POST") {
        return new Response(
            JSON.stringify({ ok: false, error: "method_not_allowed" }),
            {
                status: 405,
                headers: { ...corsHeaders, "Content-Type": "application/json" },
            },
        );
    }

    let body: { email?: string } = {};
    try {
        body = await req.json();
    } catch {
        return new Response(
            JSON.stringify({ ok: false, error: "invalid_json" }),
            {
                status: 400,
                headers: { ...corsHeaders, "Content-Type": "application/json" },
            },
        );
    }

    const email = body?.email?.trim().toLowerCase();
    if (!email || !email.includes("@")) {
        return new Response(
            JSON.stringify({ ok: false, error: "invalid_email" }),
            {
                status: 400,
                headers: { ...corsHeaders, "Content-Type": "application/json" },
            },
        );
    }

    // -------------------------------------------------
    // DEBUG LOGGING
    // -------------------------------------------------
    const supabase = serviceClient();
    console.log("SUPABASE_URL:", Deno.env.get("SUPABASE_URL"));
    console.log(
        "SERVICE_ROLE_KEY present:",
        !!Deno.env.get("SUPABASE_SERVICE_ROLE_KEY"),
    );

    // Check if email already has a code
    const { data: existingClaim } = await supabase
        .from("promo_codes")
        .select("code")
        .eq("email", email)
        .single();

    if (existingClaim) {
        console.log(`Email ${email} already claimed code ${existingClaim.code}`);
        return new Response(
            JSON.stringify({
                ok: true,
                code: existingClaim.code,
                already_claimed: true,
            }),
            { headers: { ...corsHeaders, "Content-Type": "application/json" } },
        );
    }

    // Find an unclaimed code and claim it atomically
    const { data: claimedCode, error: claimError } = await supabase
        .from("promo_codes")
        .update({ email, claimed_at: new Date().toISOString() })
        .is("email", null)
        .limit(1)
        .select("code")
        .single();

    if (claimError || !claimedCode) {
        console.error("Claim error:", claimError);
        return new Response(
            JSON.stringify({ ok: false, error: "no_codes_available" }),
            {
                status: 410,
                headers: { ...corsHeaders, "Content-Type": "application/json" },
            },
        );
    }

    console.log(`Successfully claimed code ${claimedCode.code} for ${email}`);

    // -------------------------------------------------
    // SEND EMAIL VIA POSTMARK
    // -------------------------------------------------
    const postmarkKey = Deno.env.get("POSTMARK_API_KEY");
    if (postmarkKey) {
        try {
            await fetch("https://api.postmarkapp.com/email", {
                method: "POST",
                headers: {
                    Accept: "application/json",
                    "Content-Type": "application/json",
                    "X-Postmark-Server-Token": postmarkKey,
                },
                body: JSON.stringify({
                    From: "taylor@bamber.ai",
                    To: email,
                    Subject: "Your Bamber AI Subscription Code",
                    HtmlBody: `
                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; padding: 40px 20px;">
                  <h1 style="color: #111827; font-size: 28px; margin-bottom: 20px;">ðŸŽ‰ Your Subscription Code</h1>
                  <p style="color: #6b7280; font-size: 16px; line-height: 1.6;">Thank you for your interest in Bamber AI! Here's your exclusive subscription code:</p>
                  <div style="background: linear-gradient(135deg, #6a9eff, #8b5cf6); color: white; font-size: 24px; font-weight: bold; padding: 20px; border-radius: 12px; text-align: center; margin: 24px 0; letter-spacing: 2px;">
                    ${claimedCode.code}
                  </div>
                  <p style="color: #6b7280; font-size: 16px; line-height: 1.6;">To redeem your code:</p>
                  <ol style="color: #374151; font-size: 16px; line-height: 1.8;">
                    <li>Download Bamber AI from the App Store</li>
                    <li>Open the app and go to Settings</li>
                    <li>Tap "Redeem Code" and enter your code</li>
                  </ol>
                  <a href="https://apps.apple.com/us/app/bamber-ai-for-curious-minds/id6753957399"
                     style="display: inline-block; background: linear-gradient(135deg, #6a9eff, #8b5cf6); color: white; text-decoration: none; padding: 14px 28px; border-radius: 999px; font-weight: 600; margin-top: 20px;">
                    Download Bamber AI
                  </a>
                  <p style="color: #9ca3af; font-size: 14px; margin-top: 40px;">If you have any questions, just reply to this email!</p>
                </div>
                `,
                    TextBody: `Your Bamber AI Subscription Code: ${claimedCode.code}\n\nRedeem it at: https://apps.apple.com/us/app/bamber-ai-for-curious-minds/id6753957399`,
                }),
            });
        } catch (emailError) {
            console.error("Failed to send email:", emailError);
            // We deliberately do **not** fail the request if email sending fails.
        }
    }

    return new Response(
        JSON.stringify({ ok: true, code: claimedCode.code }),
        { headers: { ...corsHeaders, "Content-Type": "application/json" } },
    );
});
