<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Bamber — Sign-in Link</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
           margin: 0; padding: 24px; background:#f6f7fb; }
    .wrap { max-width: 720px; margin: 0 auto; }
    .card { background:#fff; border-radius:16px; padding:20px 24px; box-shadow:0 6px 24px rgba(0,0,0,.07); }
    h1 { font-size:20px; margin:0 0 8px; }
    .status { padding:12px 14px; border-radius:12px; margin:12px 0 16px; font-size:14px; }
    .ok   { background:#ecfdf5; color:#065f46; }
    .warn { background:#fff7ed; color:#7c2d12; }
    .err  { background:#fef2f2; color:#7f1d1d; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .primary { appearance:none; border:0; border-radius:12px; padding:10px 14px; font-size:14px;
               cursor:pointer; background:#111827; color:#fff; text-decoration:none; }
    .section { margin-top:22px; padding-top:14px; border-top:1px solid #e5e7eb; }
    .muted { color:#4b5563; font-size:14px; }
    .small { font-size:12px; color:#6b7280; margin-top:10px; }
    a.btn { display:inline-block; border-radius:10px; padding:8px 12px; background:#e5e7eb; color:#111827; text-decoration:none; font-size:14px; margin-right:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 id="title">Checking your link…</h1>
      <div id="status" class="status"></div>

      <!-- Primary action only -->
      <div class="row">
        <a id="openBamber" class="primary" href="#">Open Bamber</a>
      </div>

      <!-- Secondary actions (moved down to reduce confusion) -->
      <div class="section">
        <p class="muted">If nothing happens:</p>
        <div class="row">
          <a id="openSafari" class="btn" href="#">Open in Safari (Universal Link)</a>
          <a id="copyUrl" class="btn" href="#">Copy this URL</a>
        </div>
        <p class="small">Tip: If you tapped from Gmail/Slack, use <em>Open in Safari</em>.</p>
        <p class="muted" id="debug"></p>
      </div>
    </div>
  </div>

  <script>
    // ---- Minimal, UL-only setup (no custom scheme) ----
    const HOST = 'https://app.funloop.com';
    const PATH = '/auth/verify';

    // Merge ?query and #hash params (hash wins on dupes)
    function mergedParams() {
      const s = new URLSearchParams(location.search);
      const h = new URLSearchParams(location.hash.replace(/^#/, ''));
      const m = new URLSearchParams();
      for (const [k,v] of s) m.set(k,v);
      for (const [k,v] of h) m.set(k,v);
      return m;
    }

    const q = mergedParams();

    // One-time re-navigation to help iOS re-trigger Universal Link handoff:
    // If there is no "ul=1", append it and navigate once. Prevent loops by only doing it when missing.
    (function maybeNudgeUniversalLink() {
      const alreadyUL = q.get('ul') === '1';
      const onTargetPath = (location.origin === HOST) && (location.pathname === PATH);
      if (onTargetPath && !alreadyUL) {
        q.set('ul', '1');
        const target = `${HOST}${PATH}?${q.toString()}`;
        // Use replace() to avoid history spam; this is a single attempt
        location.replace(target);
      }
    })();

    // Build final canonical UL (with whatever params the request has)
    const ulUrl = `${HOST}${PATH}?${q.toString()}`;

    // Wire buttons
    const openBtn = document.getElementById('openBamber');
    const safariBtn = document.getElementById('openSafari');
    const copyBtn = document.getElementById('copyUrl');
    openBtn.href = ulUrl;       // tapping tries UL again
    safariBtn.href = ulUrl;

    copyBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      try { await navigator.clipboard.writeText(location.href); } catch {}
    });

    // Status messaging
    const token = q.get('token') || q.get('access_token') || q.get('otp');
    const type  = q.get('type')  || q.get('token_type') || '';
    const error = q.get('error') || q.get('error_code');
    const desc  = q.get('error_description');

    const statusEl = document.getElementById('status');
    const titleEl  = document.getElementById('title');
    function setStatus(cls, text){ statusEl.className = `status ${cls}`; statusEl.textContent = text; }

    if (error) {
      titleEl.textContent = 'Link issue';
      setStatus('err', desc || `Error: ${error}`);
    } else if (token) {
      titleEl.textContent = 'Link looks good';
      setStatus('ok', `If the app doesn't open, tap "Open Bamber".`);
    } else {
      titleEl.textContent = 'Waiting for link parameters';
      setStatus('warn', 'No token found. Try “Open in Safari”.');
    }

    // Debug (redacted) a
    function redact(t){ return !t ? '' : (t.length<=10 ? t : t.slice(0,5)+'…'+t.slice(-5)); }
    const bits = [];
    if (type) bits.push(`type=${type}`);
    if (token) bits.push(`token=${redact(token)}`);
    if (error) bits.push(`error=${error}`);
    if (desc) bits.push(`desc=${desc}`);
    document.getElementById('debug').textContent = bits.length ? `Debug: ${bits.join('  |  ')}` : '';
  </script>
</body>
</html>
